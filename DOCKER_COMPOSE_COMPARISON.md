# üê≥ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ Docker Compose —Ñ–∞–π–ª–æ–≤

## üìã –û–±–∑–æ—Ä

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –¥–≤–∞ —Ñ–∞–π–ª–∞ Docker Compose:
- `docker-compose.yml` - –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `docker-compose.prod.yml` - –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## üîç –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è

| –ê—Å–ø–µ–∫—Ç | `docker-compose.yml` | `docker-compose.prod.yml` |
|--------|---------------------|---------------------------|
| **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ** | –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ | –ü—Ä–æ–¥–∞–∫—à–µ–Ω |
| **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–æ–≤** | 2 (db + bot) | 1 (—Ç–æ–ª—å–∫–æ bot) |
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** | –õ–æ–∫–∞–ª—å–Ω–∞—è PostgreSQL | –í–Ω–µ—à–Ω—è—è –ë–î |
| **–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞** | `start.sh` | `start_external_db.sh` |
| **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î** | `USE_EXTERNAL_DB: false` | `USE_EXTERNAL_DB: true` |

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### `docker-compose.yml` (–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î)
```yaml
services:
  db:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: md5
    ports:
      - "5432:5432"  # –ü–æ—Ä—Ç –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    command: postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf

  bot:
    depends_on:
      - db  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
```

### `docker-compose.prod.yml` (–í–Ω–µ—à–Ω—è—è –ë–î)
```yaml
services:
  bot:
    # –ù–µ—Ç —Å–µ—Ä–≤–∏—Å–∞ –ë–î - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω—è—è
    environment:
      USE_EXTERNAL_DB: true  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–Ω–µ—à–Ω—è—è –ë–î
      EXTERNAL_DB_HOST: ${EXTERNAL_DB_HOST}
      EXTERNAL_DB_PORT: ${EXTERNAL_DB_PORT:-5432}
      EXTERNAL_DB_NAME: ${EXTERNAL_DB_NAME}
      EXTERNAL_DB_USER: ${EXTERNAL_DB_USER}
      EXTERNAL_DB_PASSWORD: ${EXTERNAL_DB_PASSWORD}
      EXTERNAL_DB_SSL: ${EXTERNAL_DB_SSL:-false}
```

## üöÄ –ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞

### `docker-compose.yml`
```yaml
bot:
  command: ["bash", "start.sh"]
```
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `start.sh` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –ñ–¥–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î

### `docker-compose.prod.yml`
```yaml
bot:
  command: ["bash", "start_external_db.sh"]
```
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `start_external_db.sh` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–π –ë–î
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –≤–Ω–µ—à–Ω–µ–π –ë–î

## üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
–û–±–∞ —Ñ–∞–π–ª–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è:
- `BOT_TOKEN` - —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `ADMIN_CHAT_ID`, `ADMIN_USER_ID` - –∞–¥–º–∏–Ω—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `THREAD_*` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä–µ–¥–æ–≤ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –†–∞–∑–ª–∏—á–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ë–î

#### `docker-compose.yml`
```yaml
environment:
  USE_EXTERNAL_DB: ${USE_EXTERNAL_DB:-false}  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–æ–∫–∞–ª—å–Ω–∞—è
  DB_DSN: ${DB_DSN}  # DSN –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
  # –í–Ω–µ—à–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  EXTERNAL_DB_HOST: ${EXTERNAL_DB_HOST}
  EXTERNAL_DB_PORT: ${EXTERNAL_DB_PORT:-5432}
  # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

#### `docker-compose.prod.yml`
```yaml
environment:
  USE_EXTERNAL_DB: true  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–Ω–µ—à–Ω—è—è –ë–î
  # –¢–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î
  EXTERNAL_DB_HOST: ${EXTERNAL_DB_HOST}
  EXTERNAL_DB_PORT: ${EXTERNAL_DB_PORT:-5432}
  EXTERNAL_DB_NAME: ${EXTERNAL_DB_NAME}
  EXTERNAL_DB_USER: ${EXTERNAL_DB_USER}
  EXTERNAL_DB_PASSWORD: ${EXTERNAL_DB_PASSWORD}
  EXTERNAL_DB_SSL: ${EXTERNAL_DB_SSL:-false}
```

## üíæ Volumes

### `docker-compose.yml`
```yaml
volumes:
  pgdata:  # –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π volume –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
    driver: local

services:
  db:
    volumes:
      - pgdata:/var/lib/postgresql/data  # –î–∞–Ω–Ω—ã–µ –ë–î
      - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf:ro  # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

  bot:
    volumes:
      - .:/app  # –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```

### `docker-compose.prod.yml`
```yaml
services:
  bot:
    volumes:
      - .:/app  # –¢–æ–ª—å–∫–æ –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    # –ù–µ—Ç volumes –¥–ª—è –ë–î - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω—è—è
```

## üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### `docker-compose.yml`
```yaml
bot:
  depends_on:
    - db  # –ë–æ—Ç –∂–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
```

### `docker-compose.prod.yml`
```yaml
bot:
  # –ù–µ—Ç depends_on - –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
```

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
# –ó–∞–ø—É—Å–∫ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f bot
docker-compose logs -f db

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω
```bash
# –ó–∞–ø—É—Å–∫ —Å –≤–Ω–µ—à–Ω–µ–π –ë–î
docker-compose -f docker-compose.prod.yml up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose -f docker-compose.prod.yml logs -f bot

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose -f docker-compose.prod.yml down
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- –ü—Ä–æ—Å—Ç—ã–µ –ø–∞—Ä–æ–ª–∏ (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
- SSL –æ—Ç–∫–ª—é—á–µ–Ω
- –î–æ—Å—Ç—É–ø –∫ –ë–î —Å –ª—é–±–æ–≥–æ IP (0.0.0.0/0)
- –ü–æ—Ä—Ç 5432 –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω
- –°–ª–æ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ (—á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
- SSL –≤–∫–ª—é—á–µ–Ω (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- –î–æ—Å—Ç—É–ø –∫ –ë–î —Ç–æ–ª—å–∫–æ —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP
- –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î (–¥–∞–Ω–Ω—ã–µ –Ω–∞ –≤–Ω–µ—à–Ω–µ–º —Å–µ—Ä–≤–µ—Ä–µ)

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (`docker-compose.yml`)
‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ë–î
- –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö
- –û—Ç–ª–∞–¥–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ –ë–î (pgAdmin, DBeaver)

‚ùå **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º
- –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω (`docker-compose.prod.yml`)
‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–¥–∞–∫—à–µ–Ω –ë–î
- –ú–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (–Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î)
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
- –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

‚ùå **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–µ–π –ë–î
- –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
- –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–¥–∫–∞

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É —Å—Ä–µ–¥–∞–º–∏

### –ò–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤–Ω–µ—à–Ω–µ–π –ë–î
2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –ë–î
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å `docker-compose.prod.yml`

### –ò–∑ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É
1. –°–æ–∑–¥–∞–π—Ç–µ –±—ç–∫–∞–ø –ø—Ä–æ–¥–∞–∫—à–µ–Ω –ë–î
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å –æ–±—ã—á–Ω—ã–º `docker-compose.yml`

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `docker-compose.yml` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –±—ç–∫–∞–ø—ã –ø–µ—Ä–µ–¥ –∫—Ä—É–ø–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `docker-compose.prod.yml`
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–Ω–µ—à–Ω–µ–π –ë–î
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –±—ç–∫–∞–ø—ã
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î 